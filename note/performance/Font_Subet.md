# 字体子集 (Font Subset)

## 1. 核心概念概览

**“字体子集的核心是‘按需加载’，即从庞大的完整字体库中只提取出当前页面实际用到的字符，生成一个极小的定制字体文件，以此大幅优化前端性能。”**

*   **完整字体 (Full Font)**：包含数千甚至数万字符的原始字体文件，体积通常为几 MB 到几十 MB。
*   **字体子集 (Font Subset)**：仅包含项目中实际使用的几百或几千个字符的字体文件，体积可剧减至几十 KB。

## 2. 为什么需要字体子集 (Why)

### 2.1 性能瓶颈

一个标准的 `woff2` 格式中文字体文件通常在 1-4MB 左右。在 Web 环境中，这个大小会带来严重问题：

*   **加载延迟**: 下载几 MB 的文件会阻塞页面渲染，导致长时间的白屏或文本样式闪烁 (FOUT/FOIT)。
*   **带宽消耗**: 对用户（尤其是移动端）造成不必要的流量浪费。
*   **渲染性能**: 浏览器需要解析整个庞大的字体文件，增加了内存和 CPU 的开销。

### 2.2 优化效果

通过生成子集，字体文件可以被压缩 **90%** 以上。

*   **极速加载**: 文件体积降至 KB 级，下载速度极快。
*   **渲染体验提升**: 字体能更快地被应用，有效避免 FOUT (Flash of Unstyled Text) 和 FOIT (Flash of Invisible Text)。
*   **节省成本**: 减少了服务器的带宽成本和用户的流量消耗。

## 3. 如何实现字体子集 (How)

### 3.1 实现方式

主要分为**静态生成**和**动态生成**两种。

*   **静态生成 (Offline Subsetting)**：在项目构建阶段，通过工具扫描所有源码（HTML, Vue, JS等），找出所有使用到的字符，生成固定的子集文件。这是最常用、最推荐的方式。
*   **动态生成 (Dynamic Subsetting)**：根据用户请求的内容（如一篇动态加载的文章），由服务器实时生成对应的字体子集。此方案实现复杂，适用于内容高度动态化的场景。

### 3.2 常用工具

1.  **font-spider (字蛛)**
    *   **优点**: 自动化程度高，能自动分析本地 HTML/CSS 文件，开箱即用。
    *   **工作流程**: 在 CSS 中通过 `@font-face` 引入字体，然后运行 `font-spider` 命令即可。

    ```css
    /* 1. 在 CSS 中使用 WebFont */
    @font-face {
      font-family: 'my-font';
      src: url('../font/SourceHanSans.woff2');
    }
    .my-text {
      font-family: 'my-font';
    }
    ```
    ```bash
    # 2. 运行命令，它会自动转换
    font-spider ./index.html
    ```

2.  **fonttools (pyftsubset)**
    *   **优点**: Google 出品的底层库，功能强大，控制力最强，是很多其他上层工具的核心。
    *   **工作流程**: 需要手动提供需要保留的字符列表。

    ```bash
    # pyftsubset <原始字体> --text="需要保留的文字" --output-file=<输出字体>
    pyftsubset SourceHanSans.otf --text="你好世界123" --output-file=subset.otf
    ```

### 3.3 构建流程集成

推荐将字体子集化集成到 Webpack 或 Vite 的构建流程中，确保每次构建时都能自动更新。可以使用 `font-spider-webpack-plugin` 等插件。

## 4. 核心要点

| 要点 | 答案解析 |
| :---- | :---- |
| **是什么？** | 一种前端性能优化技术。通过从完整字体文件中提取出项目实际用到的部分字符，生成一个体积更小的字体文件。 |
| **为什么要做？** | 核心是为了**性能**。中文字体文件过大（数MB），会阻塞渲染、增加加载时间。子集化能将体积减小90%以上，极大提升加载速度和用户体验。 |
| **怎么做？** | 1. **工具**：`font-spider`（自动化分析）、`fonttools`（底层库，更灵活）。<br>2. **流程**：最常用的是在项目构建时（CI/CD）**静态分析**源码，生成子集文件。<br>3. **动态内容处理**：对于无法预知的动态文本（如用户评论），有三种策略：① **回退**到系统默认字体；② **预生成常用字库**（如常用汉字3500字）；③ **动态生成**子集（服务器端实现，较复杂）。 |
| **有何缺点？** | 主要缺点是**维护成本**。如果新增的静态文本中包含了子集里没有的字，那个字就会显示为默认字体。因此需要将其**集成到自动化构建流程**中，确保每次代码变更都重新生成子集，从而避免这个问题。 |
| **`unicode-range` 是什么？** | 是 CSS `@font-face` 的一个描述符，用来声明该字体文件只包含特定 Unicode 范围的字符。浏览器会根据当前页面需要渲染的字符，**按需下载**对应的字体文件。这对于实现更精细的字体分块加载（如基础字符集、扩展字符集分开）非常有用。 |
